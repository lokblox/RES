<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RES - ROBLOX ECONOMY SIMULATOR</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #e3e3e3;
    }
    #topbar {
      height: 40px;
      background: #232527;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 12px;
      font-size: 14px;
    }
    #topbar .logo {
      font-weight: bold;
      margin-right: 20px;
    }
    #topbar a {
      color: #fff;
      text-decoration: none;
      padding: 4px 6px;
    }
    #topbar a:hover {
      background: #3a3c3f;
    }
    #topbar input {
      margin-left: auto;
      padding: 3px 6px;
      border-radius: 2px;
      border: 1px solid #555;
      background: #111;
      color: #fff;
      font-size: 12px;
    }
    #currencyBox {
      margin-left: 10px;
      font-size: 12px;
    }
    #banner {
      background: #f8e08e;
      padding: 6px 12px;
      font-size: 13px;
      border-bottom: 1px solid #d3c06a;
    }
    #layout {
      display: flex;
      min-height: calc(100vh - 40px - 30px);
    }
    #sidebar {
      width: 180px;
      background: #f2f2f2;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      border-right: 1px solid #ccc;
      font-size: 13px;
    }
    #sidebar a {
      text-decoration: none;
      color: #333;
      padding: 4px 6px;
      border-radius: 2px;
    }
    #sidebar a:hover {
      background: #ddd;
    }
    #sidebar button {
      margin-top: 10px;
      padding: 6px;
      background: #8c52ff;
      color: #fff;
      border: none;
      border-radius: 2px;
      cursor: pointer;
      font-size: 13px;
    }
    #sidebar button:hover {
      background: #7a3fe0;
    }
    #content {
      flex: 1;
      padding: 15px;
      font-size: 14px;
    }
    h2, h3 {
      margin-top: 0;
    }
    .profile-top {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .profile-avatar {
      width: 150px;
      height: 200px;
      background: #cfcfcf;
      border: 1px solid #aaa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #555;
    }
    .profile-info {
      flex: 1;
    }
    .games-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .game-card {
      width: 140px;
      height: 90px;
      background: #dcdcdc;
      border: 1px solid #aaa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    #authBox {
      margin-left: auto;
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 12px;
    }
    #authBox input {
      background: #111;
      border: 1px solid #555;
      color: #fff;
      padding: 2px 4px;
      font-size: 12px;
    }
    #authBox button {
      padding: 3px 6px;
      border: none;
      background: #3a8bff;
      color: #fff;
      border-radius: 2px;
      cursor: pointer;
      font-size: 12px;
    }
    #authBox button:hover {
      background: #2f73d1;
    }
    #tradeLayout {
      display: flex;
      gap: 20px;
    }
    .trade-column {
      flex: 1;
      background: #f5f5f5;
      border: 1px solid #ccc;
      padding: 10px;
    }
    .trade-column h3 {
      margin-top: 0;
    }
    .trade-items {
      min-height: 80px;
      background: #fff;
      border: 1px solid #ccc;
      margin-bottom: 8px;
      padding: 4px;
      font-size: 12px;
    }
    #sendTradeBtn {
      margin-top: 10px;
      padding: 6px 10px;
      background: #3a8bff;
      color: #fff;
      border: none;
      border-radius: 2px;
      cursor: pointer;
      font-size: 13px;
    }
    #sendTradeBtn:hover {
      background: #2f73d1;
    }
    .inventory-grid, .catalog-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .inventory-item, .catalog-item {
      width: 120px;
      background: #f5f5f5;
      border: 1px solid #ccc;
      padding: 4px;
      font-size: 12px;
      text-align: center;
    }
    .inventory-thumb, .catalog-thumb {
      width: 100%;
      height: 80px;
      background: #ddd;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #555;
    }
    .friends-list, .groups-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .friend-card, .group-card {
      width: 120px;
      background: #f5f5f5;
      border: 1px solid #ccc;
      padding: 4px;
      font-size: 12px;
      text-align: center;
    }
    .membership-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .membership-box {
      background: #fff;
      padding: 15px;
      border-radius: 4px;
      width: 320px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      font-size: 13px;
    }
    .membership-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }
    .membership-option {
      padding: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      border-radius: 3px;
    }
    .membership-option:hover {
      background: #f2f2f2;
    }
    #avatarViewer {
      width: 300px;
      height: 350px;
      background: #cfcfcf;
      border: 1px solid #aaa;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div class="logo">RES</div>
    <a href="#" data-page="home">Games</a>
    <a href="#" data-page="catalog">Catalog</a>
    <a href="#" data-page="create">Create</a>
    <a href="#" data-page="download">Download</a>
    <input type="text" id="searchBox" placeholder="Search">
    <div id="currencyBox"></div>
    <div id="authBox">
      <span id="authStatus"></span>
      <input type="text" id="authUsername" placeholder="Username">
      <input type="password" id="authPassword" placeholder="Password">
      <button id="loginBtn" type="button">Login</button>
      <button id="signupBtn" type="button">Sign Up</button>
      <button id="logoutBtn" type="button" style="display:none;">Logout</button>
    </div>
  </div>

  <div id="banner">
    In demo version, please contact me if bugs.
  </div>

  <div id="layout">
    <div id="sidebar">
      <a href="#" data-page="home">Home</a>
      <a href="#" data-page="profile">Profile</a>
      <a href="#" data-page="messages">Messages</a>
      <a href="#" data-page="friends">Friends</a>
      <a href="#" data-page="avatar">Avatar</a>
      <a href="#" data-page="inventory">Inventory</a>
      <a href="#" data-page="trade">Trade</a>
      <a href="#" data-page="groups">Groups</a>
      <a href="#" data-page="forums">Forums</a>
      <button id="upgradeBtn" type="button">Upgrade Now</button>

      <div id="adminTab" style="display:none; margin-top:10px;">
        <a href="#" data-page="admin">Admin</a>
      </div>
    </div>

    <div id="content">
      <!-- pages injected here -->
    </div>
  </div>

  <!-- Three.js for avatar -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ====== SUPABASE INIT ======
    const SUPABASE_URL = 'https://dkneazwgcevliikucvog.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrbmVhendnY2V2bGlpa3Vjdm9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTgzMDMsImV4cCI6MjA4NjAzNDMwM30.PPWm7WtPSBlb1iA_4JpGwy2rwat3rU58h3oaDgL2HRg';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    // Membership payout values
    const MEMBERSHIP_PAYOUTS = {
      BC: 35,
      TBC: 85,
      OBC: 100,
      Premium: 100
    };

    async function loadCurrentUser() {
      const id = localStorage.getItem('currentUserId');
      if (!id) {
        currentUser = null;
        return;
      }
      const { data, error } = await db
        .from('users')
        .select('*')
        .eq('id', id)
        .single();
      if (error || !data) {
        console.error('loadCurrentUser error:', error);
        currentUser = null;
        localStorage.removeItem('currentUserId');
      } else {
        currentUser = data;
      }
    }

    async function signup(username, password) {
      if (!username || !password) {
        alert('Enter a username and password.');
        return;
      }

      const { data, error } = await db
        .from('users')
        .insert({ username, password })
        .select()
        .single();

      if (error) {
        console.error('signup error:', error);
        alert('Signup error: ' + (error.message || JSON.stringify(error)));
        return;
      }

      alert('Account created, logging you in...');
      localStorage.setItem('currentUserId', data.id);
      location.reload();
    }

    async function login(username, password) {
      if (!username || !password) {
        alert('Enter a username and password.');
        return;
      }

      const { data, error } = await db
        .from('users')
        .select('*')
        .eq('username', username)
        .eq('password', password)
        .maybeSingle();

      if (error) {
        console.error('login error:', error);
        alert('Login error: ' + (error.message || JSON.stringify(error)));
        return;
      }

      if (!data) {
        alert('Invalid username or password.');
        return;
      }

      alert('Logged in, reloading...');
      localStorage.setItem('currentUserId', data.id);
      location.reload();
    }

    function logout() {
      localStorage.removeItem('currentUserId');
      location.reload();
    }

    function updateAuthUI() {
      const authStatus = document.getElementById('authStatus');
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const userInput = document.getElementById('authUsername');
      const passInput = document.getElementById('authPassword');
      const currencyBox = document.getElementById('currencyBox');

      if (currentUser) {
        authStatus.textContent = 'Hello, ' + currentUser.username;
        loginBtn.style.display = 'none';
        signupBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        userInput.style.display = 'none';
        passInput.style.display = 'none';
        const robux = currentUser.robux || 0;
        const tix = currentUser.tix || 0;
        currencyBox.textContent = `R$ ${robux} | Tix ${tix}`;
      } else {
        authStatus.textContent = '';
        loginBtn.style.display = 'inline-block';
        signupBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        userInput.style.display = 'inline-block';
        passInput.style.display = 'inline-block';
        currencyBox.textContent = '';
      }
    }

    function updateAdminTab() {
      const adminTab = document.getElementById('adminTab');
      if (currentUser && currentUser.is_admin) {
        adminTab.style.display = 'block';
      } else {
        adminTab.style.display = 'none';
      }
    }

    function showPage(page) {
      if (page === 'home' || page === 'profile') {
        renderProfilePage();
      } else if (page === 'avatar') {
        renderAvatarPage();
      } else if (page === 'trade') {
        renderTradePage();
      } else if (page === 'inventory') {
        renderInventoryPage();
      } else if (page === 'friends') {
        renderFriendsPage();
      } else if (page === 'groups') {
        renderGroupsPage();
      } else if (page === 'catalog') {
        renderCatalogPage();
      } else if (page === 'admin') {
        renderAdminPage();
      } else {
        document.getElementById('content').innerHTML = '<p>Coming soon.</p>';
      }
    }

    function renderProfilePage() {
      if (!currentUser) {
        document.getElementById('content').innerHTML = '<p>Please log in.</p>';
        return;
      }
      const robux = currentUser.robux || 0;
      const tix = currentUser.tix || 0;
      document.getElementById('content').innerHTML = `
        <h2>Hello, ${currentUser.username}!</h2>
        <div class="profile-top">
          <div class="profile-avatar" id="profileAvatarCanvas">
            Avatar preview
          </div>
          <div class="profile-info">
            <p><strong>Robux:</strong> R$ ${robux}</p>
            <p><strong>Tix:</strong> ${tix}</p>
            <p><strong>Membership:</strong> ${currentUser.membership || 'None'}</p>
            <p><strong>Friends:</strong> (coming soon)</p>
            <p><strong>Messages:</strong> (coming soon)</p>
            <p><strong>Trades:</strong> (coming soon)</p>
          </div>
        </div>

        <h3>Recently Played</h3>
        <div class="games-row">
          <div class="game-card">Prison Life</div>
          <div class="game-card">Trade Hangout</div>
          <div class="game-card">Ragdoll Engine</div>
          <div class="game-card">Train VS Car</div>
        </div>

        <h3>My Favorites</h3>
        <p>No games found.</p>
      `;
    }

    // ===== 3D AVATAR (simple R6 + face plane) =====
    let avatarScene, avatarCamera, avatarRenderer, avatarModel;

    function renderAvatarPage() {
      if (!currentUser) {
        document.getElementById('content').innerHTML = '<p>Please log in.</p>';
        return;
      }
      document.getElementById('content').innerHTML = `
        <h2>Avatar</h2>
        <div id="avatarViewer"></div>
        <div style="margin-top:10px;">
          <button id="rotateLeft">Rotate Left</button>
          <button id="rotateRight">Rotate Right</button>
          <button id="resetAvatar">Reset</button>
        </div>
        <p style="margin-top:10px;">3D avatar with face plane. Hats and colors later.</p>
      `;
      initAvatarViewer();
    }

    function initAvatarViewer() {
      const container = document.getElementById('avatarViewer');
      avatarScene = new THREE.Scene();
      avatarCamera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
      avatarCamera.position.set(0, 1.5, 4);

      avatarRenderer = new THREE.WebGLRenderer({ antialias: true });
      avatarRenderer.setSize(container.clientWidth, container.clientHeight);
      container.innerHTML = '';
      container.appendChild(avatarRenderer.domElement);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(2, 5, 3);
      avatarScene.add(light);

      const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 1, metalness: 0 });

      avatarModel = new THREE.Group();

      const torso = new THREE.Mesh(new THREE.BoxGeometry(1, 1.2, 0.5), bodyMaterial);
      torso.position.set(0, 0.6, 0);
      avatarModel.add(torso);

      const head = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), bodyMaterial);
      head.position.set(0, 1.6, 0);
      avatarModel.add(head);

      const legGeom = new THREE.BoxGeometry(0.4, 1, 0.4);
      const leftLeg = new THREE.Mesh(legGeom, bodyMaterial);
      leftLeg.position.set(-0.3, -0.1, 0);
      const rightLeg = new THREE.Mesh(legGeom, bodyMaterial);
      rightLeg.position.set(0.3, -0.1, 0);
      avatarModel.add(leftLeg);
      avatarModel.add(rightLeg);

      const armGeom = new THREE.BoxGeometry(0.4, 1, 0.4);
      const leftArm = new THREE.Mesh(armGeom, bodyMaterial);
      leftArm.position.set(-0.8, 1.1, 0);
      const rightArm = new THREE.Mesh(armGeom, bodyMaterial);
      rightArm.position.set(0.8, 1.1, 0);
      avatarModel.add(leftArm);
      avatarModel.add(rightArm);

      avatarScene.add(avatarModel);

      addFacePlane(head);

      animateAvatar();

      document.getElementById('rotateLeft').onclick = () => {
        avatarModel.rotation.y += 0.2;
      };
      document.getElementById('rotateRight').onclick = () => {
        avatarModel.rotation.y -= 0.2;
      };
      document.getElementById('resetAvatar').onclick = () => {
        avatarModel.rotation.y = 0;
      };
    }

    function addFacePlane(headMesh) {
      const loader = new THREE.TextureLoader();
      const faceTexture = loader.load('/lokblox/face.png', () => {
        const facePlane = new THREE.Mesh(
          new THREE.PlaneGeometry(0.7, 0.7),
          new THREE.MeshBasicMaterial({ map: faceTexture, transparent: true })
        );
        facePlane.position.set(0, 0, 0.41);
        headMesh.add(facePlane);
      });
    }

    function animateAvatar() {
      if (!avatarRenderer) return;
      requestAnimationFrame(animateAvatar);
      avatarRenderer.render(avatarScene, avatarCamera);
    }

    // ===== TRADES =====
    function renderTradePage() {
      if (!currentUser) {
        document.getElementById('content').innerHTML = '<p>Please log in.</p>';
        return;
      }
      document.getElementById('content').innerHTML = `
        <h2>Trades</h2>
        <div id="tradeLayout">
          <div class="trade-column">
            <h3>Your Offer</h3>
            <div class="trade-items" id="yourItems">Your limiteds here (hook inventory later)</div>
            <label>RES: <input type="number" id="yourRes" value="0" style="width:80px;"></label>
          </div>
          <div class="trade-column">
            <h3>Their Offer</h3>
            <div class="trade-items" id="theirItems">Their limiteds here (select user later)</div>
            <label>RES: <input type="number" id="theirRes" value="0" style="width:80px;" disabled></label>
          </div>
        </div>
        <button id="sendTradeBtn">Send Trade</button>
      `;
      document.getElementById('sendTradeBtn').addEventListener('click', () => {
        console.log('Send trade clicked (hook Supabase trades table here)');
      });
    }

    // ===== INVENTORY =====
    async function renderInventoryPage() {
      if (!currentUser) {
        document.getElementById('content').innerHTML = '<p>Please log in.</p>';
        return;
      }
      document.getElementById('content').innerHTML = '<h2>Inventory</h2><p>Loading...</p>';

      const { data: inv, error: invErr } = await db
        .from('inventory')
        .select('item_id')
        .eq('user_id', currentUser.id);

      if (invErr) {
        console.error('inventory error:', invErr);
        document.getElementById('content').innerHTML = '<h2>Inventory</h2><p>Error loading inventory.</p>';
        return;
      }

      const itemIds = inv.map(i => i.item_id);
      if (itemIds.length === 0) {
        document.getElementById('content').innerHTML = '<h2>Inventory</h2><p>You have no items.</p>';
        return;
      }

      const { data: items, error: itemsErr } = await db
        .from('items')
        .select('*')
        .in('id', itemIds);

      if (itemsErr) {
        console.error('items error:', itemsErr);
        document.getElementById('content').innerHTML = '<h2>Inventory</h2><p>Error loading items.</p>';
        return;
      }

      let html = '<h2>Inventory</h2><div class="inventory-grid">';
      for (const item of items) {
        html += `
          <div class="inventory-item">
            <div class="inventory-thumb">
              ${item.thumbnail ? `<img src="${item.thumbnail}" style="max-width:100%;max-height:100%;">` : 'No thumbnail'}
            </div>
            <div><strong>${item.name}</strong></div>
            <div style="font-size:11px;">${item.type || ''}</div>
          </div>
        `;
      }
      html += '</div>';
      document.getElementById('content').innerHTML = html;
    }

    // ===== CATALOG =====
    async function renderCatalogPage() {
      document.getElementById('content').innerHTML = '<h2>Catalog</h2><p>Loading...</p>';

      const { data: items, error } = await db
        .from('items')
        .select('*')
        .order('id', { ascending: true });

      if (error) {
        console.error('catalog error:', error);
        document.getElementById('content').innerHTML = '<h2>Catalog</h2><p>Error loading catalog.</p>';
        return;
      }

      if (!items || items.length === 0) {
        document.getElementById('content').innerHTML = '<h2>Catalog</h2><p>No items found.</p>';
        return;
      }

      let html = '<h2>Catalog</h2><div class="catalog-grid">';
      for (const item of items) {
        html += `
          <div class="catalog-item">
            <div class="catalog-thumb">
              ${item.thumbnail ? `<img src="${item.thumbnail}" style="max-width:100%;max-height:100%;">` : 'No thumbnail'}
            </div>
            <div><strong>${item.name}</strong></div>
            <div style="font-size:11px;">${item.type || ''}</div>
            <div style="font-size:11px;">R$ ${item.price_robux || 0} | Tix ${item.price_tix || 0}</div>
          </div>
        `;
      }
      html += '</div>';
      document.getElementById('content').innerHTML = html;
    }

    // ===== FRIENDS =====
    function renderFriendsPage() {
      if (!currentUser) {
        document.getElementById('content').innerHTML = '<p>Please log in.</p>';
        return;
      }
      document.getElementById('content').innerHTML = `
        <h2>Friends</h2>
        <div class="friends-list">
          <div class="friend-card">Friend 1</div>
          <div class="friend-card">Friend 2</div>
          <div class="friend-card">Friend 3</div>
          <div class="friend-card">Friend 4</div>
        </div>
        <p style="margin-top:10px;">Friends system placeholder (hook Supabase friends table later).</p>
      `;
    }

    // ===== GROUPS =====
    async function renderGroupsPage() {
      if (!currentUser) {
        document.getElementById('content').innerHTML = '<p>Please log in.</p>';
        return;
      }
      document.getElementById('content').innerHTML = '<h2>Groups</h2><p>Loading...</p>';

      const { data: memberships, error: memErr } = await db
        .from('group_members')
        .select('group_id')
        .eq('user_id', currentUser.id);

      if (memErr) {
        console.error('groups error:', memErr);
        document.getElementById('content').innerHTML = '<h2>Groups</h2><p>Error loading groups.</p>';
        return;
      }

      if (!memberships || memberships.length === 0) {
        document.getElementById('content').innerHTML = '<h2>Groups</h2><p>You are not in any groups.</p>';
        return;
      }

      const groupIds = memberships.map(m => m.group_id);
      const { data: groups, error: groupsErr } = await db
        .from('groups')
        .select('*')
        .in('id', groupIds);

      if (groupsErr) {
        console.error('groups load error:', groupsErr);
        document.getElementById('content').innerHTML = '<h2>Groups</h2><p>Error loading groups.</p>';
        return;
      }

      let html = '<h2>Groups</h2><div class="groups-list">';
      for (const g of groups) {
        html += `
          <div class="group-card">
            <div><strong>${g.name}</strong></div>
            <div style="font-size:11px;">${g.description || ''}</div>
          </div>
        `;
      }
      html += '</div>';
      document.getElementById('content').innerHTML = html;
    }

    // ===== ADMIN =====
    function renderAdminPage() {
      if (!currentUser || !currentUser.is_admin) {
        document.getElementById('content').innerHTML = '<p>Access denied.</p>';
        return;
      }
      document.getElementById('content').innerHTML = `
        <h2>Admin Panel</h2>
        <p>Admin commands go here. (Only visible if is_admin = true)</p>
      `;
    }

    // Membership chooser
    function openMembershipOverlay() {
      const overlay = document.createElement('div');
      overlay.className = 'membership-overlay';
      overlay.innerHTML = `
        <div class="membership-box">
          <h3>Choose a Membership</h3>
          <p>Select a membership tier:</p>
          <div class="membership-options">
            <div class="membership-option" data-tier="BC">Builders Club (35/day)</div>
            <div class="membership-option" data-tier="TBC">Turbo Builders Club (85/day)</div>
            <div class="membership-option" data-tier="OBC">Outrageous Builders Club (100/day)</div>
            <div class="membership-option" data-tier="Premium">Premium (100/day)</div>
          </div>
          <button id="closeMembership" style="margin-top:10px;">Close</button>
        </div>
      `;
      document.body.appendChild(overlay);

      overlay.addEventListener('click', async (e) => {
        if (e.target.id === 'closeMembership' || e.target === overlay) {
          document.body.removeChild(overlay);
          return;
        }

        const opt = e.target.closest('.membership-option');
        if (!opt) return;

        const tier = opt.dataset.tier;

        await db.from('users')
          .update({ membership: tier })
          .eq('id', currentUser.id);

        currentUser.membership = tier;
        alert(`You are now ${tier}! You will receive ${MEMBERSHIP_PAYOUTS[tier]} Robux daily.`);
        document.body.removeChild(overlay);
        updateAuthUI();
      });
    }

    // Daily payout
    async function checkDailyPayout() {
      if (!currentUser || !currentUser.membership) return;

      const today = new Date().toDateString();

      if (currentUser.last_payout === today) return;

      const amount = MEMBERSHIP_PAYOUTS[currentUser.membership] || 0;

      await db.from('users')
        .update({
          robux: (currentUser.robux || 0) + amount,
          last_payout: today
        })
        .eq('id', currentUser.id);

      currentUser.robux = (currentUser.robux || 0) + amount;
      currentUser.last_payout = today;
    }

    // Global click handlers
    document.addEventListener('click', (e) => {
      const link = e.target.closest('[data-page]');
      if (link) {
        e.preventDefault();
        const page = link.dataset.page;
        showPage(page);
      }
    });

    document.getElementById('loginBtn').addEventListener('click', () => {
      const u = document.getElementById('authUsername').value.trim();
      const p = document.getElementById('authPassword').value.trim();
      login(u, p);
    });

    document.getElementById('signupBtn').addEventListener('click', () => {
      const u = document.getElementById('authUsername').value.trim();
      const p = document.getElementById('authPassword').value.trim();
      signup(u, p);
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      logout();
    });

    document.getElementById('upgradeBtn').addEventListener('click', () => {
      if (!currentUser) {
        alert('Log in first.');
        return;
      }
      openMembershipOverlay();
    });

    window.addEventListener('load', async () => {
      await loadCurrentUser();
      await checkDailyPayout();
      updateAuthUI();
      updateAdminTab();
      showPage('home');
    });
  </script>
</body>
</html>
